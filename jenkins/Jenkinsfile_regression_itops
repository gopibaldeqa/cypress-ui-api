
pipeline {
    environment {
        IMAGE_NAME = 'smartops/regression'
    }

    agent { label "${NODE_LABEL}" }

    options {
        skipDefaultCheckout(true)
    }

    tools {
        maven 'jenkins-maven'
    }

    stages {
        stage('Initialize') {
            steps {
                sh '''
                    echo "PATH = ${PATH}"
                    echo "M2_HOME = ${M2_HOME}"
                '''
            }
        }

        stage('clean workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout') {
            steps {
                git branch: "${Branch}", credentialsId: 'smartops_devops', url: 'https://USTInnovationEngineering@dev.azure.com/USTInnovationEngineering/USTP-SMOP-BU-00_SmartOpsQAAutomation/_git/itops-automation'
            }
        }

        stage('Test Setup') {
            steps {
                
                echo '[INFO] Executing npm install'
                sh '''
               pwd
               ls
                npm install
                
                '''
            }
        }

            
            stage('batch1') {

                steps {
                    catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                        echo '[INFO] Executing Regression Test'
                        sh """
                    npx cypress run --env grepTags=@${Tag},ENV="${Environment_Name}" --browser ${Browser}
                   """
                    }
                }
            }

    }

    post {
        always {
            emailext(
                  subject: "Regression Test results for itops . Job '${env.JOB_NAME} . Build No ${env.BUILD_NUMBER}'",
                  body: """Please see the below link  for regression test result
                  ${env.BUILD_URL}/execution/node/3/ws/cypress/reports/""",
                   to: '177777@ust-global.com,harish.bolishetty@ust.com,lovababu.Kada@ideabytes.com,Sravana.vanam@ideabytes.com,jyothsna.chennuri@ust-global.com',
                  from: 'noreplysmartopssvc@ust-global.com',
                  mimeType: 'text/plain'

            )
        }
    }
}
